#!/bin/bash

# Ref: https://github.com/femiwiki/docker-mediawiki/blob/master/run

set -euo pipefail; IFS=$'\n\t'

: ${MEDIAWIKI_HAS_ALREADY_DATABASE:=false}

echo 'Starting Wiki ...'

cd /usr/src

# LocalSettings is needed for wiki database already set, but ignore this line if locally run
if [ $MEDIAWIKI_HAS_ALREADY_DATABASE = true ]; then
  echo 'Wiki has already Database ...'

  ln -sf /ct/LocalSettings.php /usr/src/LocalSettings.php
fi

# If there is no LocalSettings.php, create one using maintenance/install.php
if [ ! -f /usr/src/LocalSettings.php ]; then
  DB_PREFIX="$(php -r 'require "/ct/secret.php"; echo $wgDBprefix;')"
  DB_NAME="$(php -r 'require "/ct/secret.php"; echo $wgDBname;')"
  DB_HOSTNAME="$(php -r 'require "/ct/secret.php"; echo $wgDBserver;')"
  DB_USERNAME="$(php -r 'require "/ct/secret.php"; echo $wgDBuser;')"
  DB_PASSWORD="$(php -r 'require "/ct/secret.php"; echo $wgDBpassword;')"

  php /usr/src/maintenance/install.php \
    --lang ko \
    --scriptpath '' \
    --dbtype mysql \
    --dbname ${DB_NAME} \
    --dbserver "${DB_HOSTNAME}" \
    --dbuser "${DB_USERNAME}" \
    --dbpass "${DB_PASSWORD}" \
    --dbprefix "${DB_PREFIX}" \
    --installdbuser "${DB_USERNAME}" \
    --installdbpass "${DB_PASSWORD}" \
    --pass 'admin_password_please_change' \
    '한양위키' Admin

  # Overwrite LocalSettings.php generated by install script
  ln -sf /ct/LocalSettings.php /usr/src/LocalSettings.php
fi

# Run update script
php /usr/src/maintenance/update.php --quick

# run PHP FPM
php-fpm
